
<html>
  <head>
    <title>ToriNotify</title>
    <meta charset="UTF-8">
    <link rel="icon" href="/favicon-192x192.png">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <link rel="manifest" href="/manifest.json">

    <script src="https://cdn.jsdelivr.net/npm/vue@2"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/MaterialDesign-Webfont/5.3.45/css/materialdesignicons.min.css">
    <!-- Vuetify -->
    <script src="https://cdn.jsdelivr.net/npm/vuetify@2.x/dist/vuetify.js"></script>
    <link href="https://cdn.jsdelivr.net/npm/vuetify@2.x/dist/vuetify.min.css" rel="stylesheet">
    <script src="https://unpkg.com/lodash@4.17.14/lodash.min.js"></script>
    <script src="https://unpkg.com/axios@1.0.0/dist/axios.min.js"></script>

    <script>
      const VAPID_PUBLIC_KEY = '';
    </script>
    <script src="/client.js"></script>
  </head>
  <body>
    <a href="#" id="promptLink" onclick="onPromptClick()">Enable notifications</a>
    <div id="app"></div>
    <template id="vue-app">
      <v-app data-app>
        <v-main>
          <v-toolbar dark color="primary" fixed>
            <h1>ToriNotify</h1>
            <v-spacer></v-spacer>
            <v-btn v-if="!selectedWatcherID" icon @click="createWatcher">
              <v-icon>mdi-plus</v-icon>
            </v-btn>
            <v-btn v-if="selectedWatcherID" icon @click="selectedWatcherID = null">
              <v-icon>mdi-arrow-left</v-icon>
            </v-btn>
          </v-toolbar>
          <v-container v-if="!selectedWatcherID">
            <v-row v-for="watcher in watchers" :key="watcher.id" @click="selectedWatcherID = watcher.id">
              <v-col cols="12">
                <v-card>
                  <v-card-title>
                    <h3>{{ watcher.name || 'Tyhjä hakuvahti' }}</h3>
                  </v-card-title>
                  <v-card-text>
                    <p>{{ watcher.url }}</p>
                  </v-card-text>
                </v-card>
              </v-col>
            </v-row>
          </v-container>
          <v-container v-else-if="!editingWatcher">
            <v-row>
              <v-col cols="12">
                <v-card>
                  <v-card-title>
                    <h3>{{ selectedWatcher.name || 'Tyhjä hakuvahti' }}</h3>
                    <v-spacer></v-spacer>
                    <v-btn icon @click="updateWatcher">
                      <v-icon>mdi-refresh</v-icon>
                    </v-btn>
                    <v-btn icon @click="editingWatcher = true">
                      <v-icon>mdi-pencil</v-icon>
                    </v-btn>
                  </v-card-title>
                  <v-card-text>
                    <p>{{ selectedWatcher.url }}</p>
                  </v-card-text>
                </v-card>
              </v-col>
            </v-row>
            <v-row v-for="item in selectedWatcher.rows" :key="item.id">
              <v-col cols="12">
                <v-card>
                  <v-card-title>
                    <h3>{{ item.title }}</h3>
                  </v-card-title>
                  <v-card-text>
                    <v-row>
                      <v-col cols="3">
                        <p>{{ item.price }} e</p>
                      </v-col>
                    </v-row>
                    <v-row>
                      <v-col cols="3" style="padding: 0;">
                        <img :src="item.thumbnail" style="max-width: 100%">
                      </v-col>
                      <v-col cols="9">
                      <p>{{ item.url }}</p>
                      </v-col>
                    </v-row>
                  </v-card-text>
                </v-card>
              </v-col>
          </v-container>
          <v-container v-else>
            <v-row>
              <v-col cols="12">
                <v-card>
                  <v-card-title>
                    <h3>Muokkaa hakuvahtia</h3>
                    <v-spacer></v-spacer>
                    <v-btn icon @click="editingWatcher = false">
                      <v-icon>mdi-close</v-icon>
                    </v-btn>
                  </v-card-title>
                  <v-card-text>
                    <v-text-field label="Nimi" v-model="selectedWatcher.name"></v-text-field>
                    <v-text-field label="URL" v-model="selectedWatcher.url"></v-text-field>
                  </v-card-text>
                  <v-card-actions>
                    <v-btn @click="editingWatcher = false">Peruuta</v-btn>
                    <v-btn color="error" @click="deleteWatcher">Poista</v-btn>
                    <v-btn color="primary" @click="saveWatcher">Tallenna</v-btn>
                  </v-card-actions>
                </v-card>
              </v-col>
            </v-row>
          </v-container>
        </v-main>
      </v-app>
    </template>
    <script>
      new Vue({
        el: '#app',
        template: '#vue-app',
        vuetify: new Vuetify(),

        data: () => ({
          selectedWatcherID: null,
          editingWatcher: false,

          watchers: {},
        }),

        computed: {
          selectedWatcher() {
            if (!this.selectedWatcherID) return null;
            return this.watchers[this.selectedWatcherID];
          }
        },

        mounted() {
          this.getWatchers().then(response => {
            this.$set(this, 'watchers', response.data)
          });
        },

        methods: {
          getAuthorization() {
            return window.localStorage.getItem('username') + ":" + window.localStorage.getItem('password');
          },
          authAxios(method, url, data, headers = {}) {
            return axios.create({
              headers: {
                'Authorization': this.getAuthorization(),
                ...headers,
              }
            })[method](url, data);
          },
          authGet(url, headers = {}) {
            return this.authAxios('get', url, {}, headers);
          },
          authPost(url, data, headers = {}) {
            return this.authAxios('post', url, data, headers);
          },
          authDelete(url, headers = {}) {
            return this.authAxios('delete', url, {}, headers);
          },
          authPatch(url, data, headers = {}) {
            return this.authAxios('patch', url, data, headers);
          },
          async getWatchers() {
            return this.authGet('/api/watchers');
          },
          async createWatcher() {
            if (!confirm('Haluatko varmasti luoda uuden hakuvahtisi?')) return;
            const response = await this.authPost('/api/watchers', {
              username: window.localStorage.getItem('username'),
            });
            this.watchers.push(response.data);
          },
          async saveWatcher() {
            if (!this.selectedWatcher) return;
            const newData = await this.authPatch('/api/watchers/' + this.selectedWatcher.id, this.selectedWatcher);
            this.editingWatcher = false;
            this.$set(this.watchers, this.selectedWatcherID, newData.data);
          },
          async deleteWatcher() {
            if (!this.selectedWatcher) return;
            if (!confirm('Haluatko varmasti poistaa hakuvahtisi?')) return;
            await this.authDelete('/api/watchers/' + this.selectedWatcher.id);
            this.$delete(this.watchers, this.selectedWatcherID);
            this.selectedWatcherID = null;
          },
          async updateWatcher() {
            if (!this.selectedWatcher) return;
            const response = await this.authGet('/api/watchers/' + this.selectedWatcher.id);
            this.$set(this.watchers, this.selectedWatcherID, response.data);
          }
        }
      });
    </script>
  </body>
</html>
